function dialogSet(e,t){$("div.ui-dialog span.ui-dialog-title").html(e),$(dialogDiv).html(t),$(dialogDiv).dialog("open"),$("#newName").focus()}function bindFolderContextMenu(){return $(".ui-dynatree-document, .ui-dynatree-folder").not("#ui-dynatree-id-root").contextMenu($cfg.menu.folder,{theme:$cfg.skin,beforeShow:function(){$cfg.dir=decodeURIComponent($(this.target).attr("id")),$cfg.dir=$cfg.dir.substr($cfg.cutKey);for(var e in $lang)$('span[lang="'+e+'"]',$(this.menu)).text($lang[e])}})}function bindFileContextMenu(){return $("#fileThumb .thumb, #fileList .name").contextMenu($cfg.menu.file,{theme:$cfg.skin,beforeShow:function(){$cfg.file=$cfg.view.thumb?$(".name",this.target).text():$("a",this.target).parent().text(),""==$(this.target).attr("thumb")?$(this.menu).find(".context-menu-item").eq(1).toggleClass("context-menu-item-disabled"):$(this.menu).find(".context-menu-item").eq(1).removeClass("context-menu-item-disabled");for(var e in $lang)$('span[lang="'+e+'"]',$(this.menu)).text($lang[e])}})}function _setReturnData(e,t){switch($cfg.returnTo){case"ckeditor":window.top.opener.CKEDITOR.tools.callFunction(parseUrl("CKEditorFuncNum"),e,t),window.top.close(),window.top.opener.focus();break;case"tinymce":var i=window.dialogArguments||opener||parent||top;tinyMCE=i.tinyMCE;var n=tinyMCE.activeEditor.windowManager.params;n.window.document.getElementById(n.input).value=e;try{n.window.ImageDialog.showPreviewImage(e)}catch(l){}window.close();break;default:try{if("$"==$cfg.returnTo.substr(0,1)){var a=$cfg.returnTo.substr(1);window.top.opener.document.getElementById(a).value=e}else window.top.opener[$cfg.returnTo](e);window.close()}catch(l){alert("Function is not available or does not exist: "+$cfg.returnTo+"\r"+l.message)}}return!0}function viewsUpdate(e){"root"!=e&&$.post($ajaxConnector+"?mode=getFiles",{dir:e,type:$cfg.type,lang:$cfg.lang,sort:$cfg.sort},function(e){appendFiles(e)},"json")}function appendFiles(e){$(">div.l",statusDiv).html("<div>"+$cfg.url+$cfg.dir+"/</div><div><b>"+e.files.length+"</b> "+$lang.fileOf+"</div>");var t=e.files,i="",n="",l="",a="";for(var o in t)a='file="'+($cfg.url+$cfg.dir+"/"+t[o].name)+'" thumb="'+(t[o].width?$cfg.url+$cfg.thumb+"/"+$cfg.dir+"/"+t[o].name:"")+'"',n+='<div class="thumb ext_'+t[o].ext+'" '+a+'><div class="image">',t[o].width?(l="("+t[o].width+" x "+t[o].height+") ",n+='<img src="'+t[o].thumb+'" alt="" />'):(l="",n+='<img src="skin/.gif" alt="" />'),n+='</div><div class="check"><input type="checkbox" name="file[]" value="'+t[o].name+'" /></div>',n+='<div class="name" '+($cfg.display.fileName?'style="display:block;"':'style="display:none"')+">"+t[o].name+"</div>",n+='<div class="date" '+($cfg.display.fileDate?'style="display:block;"':'style="display:none"')+">"+t[o].date+"</div>",n+='<div class="size" '+($cfg.display.fileSize?'style="display:block;"':'style="display:none"')+">"+l+t[o].size+"</div>",n+="</div>",i+="<tr>",i+='<td><input type="checkbox" name="file[]" value="'+t[o].name+'" /></td>',i+='<td><div class="name"'+a+'><a href="">'+t[o].name+"</a></div></td>",i+='<td><div class="date">'+t[o].date+"</div></td>",i+='<td><div class="size">'+l+t[o].size+"</div></td>",i+="</tr>";$("#fileThumb").html(n),$("#fileList > table > tbody").html(i),$("#fileThumb > div.thumb").each(function(){var e=$(this);e.click(function(){$("#fileThumb > div").removeClass("thumbClick"),$cfg.file=$(".name",e).text(),$cfg.thumb=$(e).attr("thumb"),$(">div.l",statusDiv).html('<div class="cutName"><a href="'+$cfg.url+$cfg.dir+"/"+$cfg.file+'" target="_urlFile">'+$cfg.url+$cfg.dir+"/"+$cfg.file+"</a></div><div>"+$lang.fileSize+": "+$(".size",e).text()+"</div><div>"+$lang.fileDate+": "+$(".date",e).text()+"</div>"),e.addClass("thumbClick")}).mouseover(function(){e.addClass("thumbOver")}).mouseout(function(){e.removeClass("thumbOver")}).dblclick(function(){_setReturnData($cfg.url+$cfg.dir+"/"+$(".name",e).text())}),$("#fileList .name a").dblclick(function(){return _setReturnData($cfg.url+$cfg.dir+"/"+$(this).text()),!1}).click(function(){return $cfg.file=$(this).text(),$(">div.l",statusDiv).html('<div class="cutName"><a href="'+$cfg.url+$cfg.dir+"/"+$cfg.file+'" target="_urlFile">'+$cfg.url+$cfg.dir+"/"+$cfg.file+"</a></div><div>"+$lang.fileSize+": "+$(".size",e).text()+"</div><div>"+$lang.fileDate+": "+$(".date",e).text()+"</div>"),!1})}),$('#fileList input[name="file\\[\\]"]').click(function(){$(this).attr("checked")?$('#fileThumb input[value="'+$(this).attr("value")+'"]').attr("checked","checked"):$('#fileThumb input[value="'+$(this).attr("value")+'"]').removeAttr("checked")}),$('#fileThumb input[name="file\\[\\]"]').click(function(){$(this).attr("checked")?$('#fileList input[value="'+$(this).attr("value")+'"]').attr("checked","checked"):$('#fileList input[value="'+$(this).attr("value")+'"]').removeAttr("checked")}),$cfg.contextmenu?bindFileContextMenu():null}function parseUrl(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t="[\\?&]"+e+"=([^&#]*)",i=new RegExp(t),n=i.exec(window.location.href);return null==n?"":n[1]}var $cfg={display:{fileName:!0,fileDate:!1,fileSize:!1},view:{list:!1,thumb:!0},menu:{file:{},folder:{}},contextmenu:!0,cutKey:15,dir:"",file:"",thumb:"",skin:"dark",lang:"ru",type:"file",sort:"name",returnTo:"ckeditor",tmp:[]};""!=(isSkin=parseUrl("skin"))&&($cfg.skin=isSkin),""!=(isType=parseUrl("type"))&&($cfg.type=isType),""!=(isReturn=parseUrl("returnTo"))&&($cfg.returnTo=isReturn),""!=(isCMenu=parseUrl("contextmenu"))&&($cfg.contextmenu="true"==isCMenu?!0:!1),""!=(isLang=parseUrl("langCode"))&&($cfg.lang=isLang),""!=(isLang=parseUrl("lang"))&&($cfg.lang=isLang);var $ajaxConnector="ajax/php/ajax.php";if(""!=(isConnector=parseUrl("connector")))switch(isConnector){case"###":break;case"php":}$("head").prepend('<script type="text/javascript" src="lang/'+$cfg.lang+'.js"></script>'),$("head").append('<link type="text/css" href="skin/'+$cfg.skin+"/"+$cfg.skin+'.css" rel="stylesheet" />'),$cfg.contextmenu&&$("head").append('<script type="text/javascript" src="lib/jquery.contextmenu.js"></script>');var menuDiv={},statusDiv={},dialogDiv={},Action={createFolder:function(){return"root"==$cfg.dir||""==$cfg.dir?!1:($cfg.tmp.mode="createFolder",$cfg.tmp.oldname=$cfg.dir,$cfg.tmp.key=$cfg.dir,dialogSet($lang.enterNameCreateFolder,"<b>"+$lang.location+"</b> ["+$cfg.url+$cfg.dir+'/]<br /><input type="text" id="newName" value="" class="t" /><br />'+$lang.allowRegSymbol),void 0)},renameFolder:function(){var e=$cfg.dir.split("/");if(1!=e.length){var t=e[e.length-1],i=$cfg.dir.substring(0,$cfg.dir.lastIndexOf("/"));$cfg.tmp.mode="renameFolder",$cfg.tmp.oldname=$cfg.dir,$cfg.tmp.key=i,dialogSet($lang.enterNewNameFolder,"<b>"+t+"</b> ["+$cfg.url+i+'/]<br /><input type="text" id="newName" value="" class="t" /><br />'+$lang.allowRegSymbol)}},deleteFolder:function(){return"root"==$cfg.dir||""==$cfg.dir?!1:($("#dirsList").dynatree("disable"),$.post($ajaxConnector+"?mode=deleteFolder",{dir:$cfg.dir,type:$cfg.type,lang:$cfg.lang},function(e){if($("#dirsList").dynatree("enable"),e.isDelete){var t=$cfg.dir.substring(0,$cfg.dir.lastIndexOf("/")),i=$("#dirsList").dynatree("getTree"),n=i.getNodeByKey(encodeURIComponent(t));n.reload(!0),$(">div.l",statusDiv).html('<div class="warning"><b>'+$lang.successDeleteFolder+"</b></div>")}else $(">div.l",statusDiv).html('<div class="warning"><b>'+$lang.failedDeleteFolder+"</b></div>")},"json"),void 0)},uploadFolder:function(){if(""==$("input:file").val())return $(">div.l",statusDiv).html('<div class="successUpload"><b>'+$lang.chooseDownloads+"</b></div>"),void 0;var e=$("#dowloaded");e.html('<div class="isDownload">'+$lang.resultUpload+"</div>").fadeIn(1e3),$("#filesUploadForm").ajaxSubmit({url:$ajaxConnector+"?mode=uploads",type:"post",dataType:"json",beforeSubmit:function(){var e=$("#filesUploadForm");return $('input[name="dir"]',e).val($cfg.dir),$('input[name="type"]',e).val($cfg.type),!0},success:function(t){$("input:file").MultiFile("reset");var i="";if(t.downloaded.length){$(">div.l",statusDiv).html('<div class="successUpload"><b>'+$lang.successUpload+"</b></div>");for(var n=-1;++n<t.downloaded.length;)i+=t.downloaded[n][0]?'<div><span class="ok">ok</span> '+t.downloaded[n][1]+"</div>":'<div><span class="no">no</span> '+t.downloaded[n][1]+"</div>";viewsUpdate($cfg.dir),e.append(i),setTimeout("$('#dowloaded').fadeOut(3000);",2e3)}else e.fadeOut(1)}})},deleteFiles:function(){var e=[];$('#fileThumb input[name="file\\[\\]"]:checked').each(function(){e.push(this.value)}),e.length&&$.post($ajaxConnector+"?mode=deleteFiles",{dir:$cfg.dir,files:e.join("::"),type:$cfg.type,lang:$cfg.lang},function(e){appendFiles(e)},"json")},deleteFile:function(){return""==$cfg.file?!1:($.post($ajaxConnector+"?mode=deleteFiles",{dir:$cfg.dir,files:$cfg.file,type:$cfg.type,lang:$cfg.lang},function(e){appendFiles(e)},"json"),void 0)},renameFile:function(){return""==$cfg.file?!1:($cfg.tmp.mode="renameFile",$cfg.tmp.oldname=$cfg.file,$cfg.tmp.key="",dialogSet($lang.enterNewNameFile,"<b>"+$cfg.file+"</b> ["+$cfg.url+$cfg.dir+'/]<br /><input type="text" id="newName" value="" class="t" /><br />'+$lang.allowRegSymbol),void 0)},downloadFile:function(){return""==$cfg.file?!1:(location.replace($ajaxConnector+"?downloadFile="+$cfg.dir+"/"+$cfg.file),void 0)},lookFile:function(){return""==$cfg.file?!1:(window.open($cfg.url+$cfg.dir+"/"+$cfg.file,"preView",""),void 0)},setThumb:function(){return""==$cfg.file?!1:(_setReturnData($cfg.thumb),void 0)},setFile:function(){return""==$cfg.file?!1:(_setReturnData($cfg.url+$cfg.dir+"/"+$cfg.file),void 0)}};$(document).ready(function(){$("#loading").bind("ajaxSend",function(){$(this).show()}).bind("ajaxComplete",function(){$(this).hide()}),$.post($ajaxConnector+"?mode=cfg",{type:$cfg.type,lang:$cfg.lang},function(e){for(var t in e.config)$cfg[t]=e.config[t];$("#dirsList").dynatree({title:"upload",rootVisible:!0,persist:!0,clickFolderMode:1,fx:{height:"toggle",duration:200},children:$cfg.children,onActivate:function(e){$cfg.file="",$cfg.dir=decodeURIComponent(e.data.key),viewsUpdate(e.data.key)},onLazyRead:function(e){return $.post($ajaxConnector+"?mode=getDirs",{dir:e.data.key,type:$cfg.type,lang:$cfg.lang},function(t){e.addChild(t.dirs),e.setLazyNodeStatus(DTNodeStatus_Ok),$cfg.contextmenu?bindFolderContextMenu():null},"json"),!1}}),""!=(tmp=$.cookie("dynatree-active"))&&($cfg.file="",$cfg.dir=decodeURIComponent(tmp),viewsUpdate(tmp)),$cfg.contextmenu?bindFolderContextMenu():null,$(".multi").MultiFile({max:16,accept:$cfg.allow,list:"#uploadList",STRING:{remove:$lang.removeFile,selected:$lang.selected,denied:$lang.deniedExt,duplicate:$lang.duplicate}}),""!=$cfg.maxUpload&&$('span[lang="chooseFileUpload"]',$("#uploadList")).append(" <"+$cfg.maxUpload),$("head").append('<style type="text/css">#fileThumb .thumb img {width: '+$cfg.thumbWidth+"px;height:"+$cfg.thumbHeight+"px;} #fileThumb .name {width: "+$cfg.thumbWidth+"px;}</style>")},"json"),$(".dirsMenu a",$("#dirs")).click(function(){return"block"==$("#author").css("display")?$("#author").hide():$("#author").css({left:"30%",top:"20%"}).show(),!1}),menuDiv=$("#menu"),statusDiv=$("#status"),dialogDiv=$("#dialog");for(var e in $lang)$('span[lang="'+e+'"]').text($lang[e]);$('.view label[for="viewlist"], .view label[for="viewthumb"]',menuDiv).click(function(){$("#viewlist").attr("checked")?($("#fileThumb").hide(),$("#fileList").show(),$cfg.view.list=!0,$cfg.view.thumb=!1):($("#fileList").hide(),$("#fileThumb").show(),$cfg.view.list=!1,$cfg.view.thumb=!0)}),$(".display label",menuDiv).click(function(){var e=$(this).attr("for"),t=e.substring(4).toLowerCase();$("#"+e).attr("checked")?($("#fileThumb ."+t).show(),$cfg.display[e]=!0):($("#fileThumb ."+t).hide(),$cfg.display[e]=!1)}),$("#checkAll").click(function(){$(this).attr("checked")?$('#fileList tbody input[name="file\\[\\]"], #fileThumb input[name="file\\[\\]"]').attr("checked","checked"):$('#fileList tbody input[name="file\\[\\]"], #fileThumb input[name="file\\[\\]"]').removeAttr("checked")}),$(".sort label",menuDiv).click(function(){var e=$(this).attr("for");$cfg.sort=e.substring(4).toLowerCase(),viewsUpdate($cfg.dir)}),$(".dirsMenu .folderMenu",$("#dirs")).html('			<a href="#" onclick="Action.uploadFolder()" class="uploadFolder" title="'+$lang.uploadSelectFiles+'"></a>			<a href="#" class="separator"></a>			<a href="#" onclick="Action.deleteFolder()" class="deleteFolder" title="'+$lang.deleteFolder+'"></a>			<a href="#" onclick="Action.renameFolder()" class="renameFolder" title="'+$lang.renameFolder+'"></a>			<a href="#" onclick="Action.createFolder()" class="createFolder" title="'+$lang.createFolder+'"></a>	'),$(".r div",statusDiv).html('			<a href="#" onclick="Action.deleteFiles()" class="deleteFiles" title="'+$lang.deleteCheckedFile+'"></a>			<a href="#" onclick="Action.deleteFile()" class="deleteFile" title="'+$lang.deleteFile+'"></a>			<a href="#" class="separator"></a>			<a href="#" onclick="Action.renameFile()" class="renameFile" title="'+$lang.renameFile+'"></a>			<a href="#" onclick="Action.downloadFile()" class="downloadFile" title="'+$lang.downloadFile+'"></a>			<a href="#" onclick="Action.lookFile()" class="lookFile" title="'+$lang.lookAt+'"></a>			<a href="#" class="separator"></a>			<a href="#" onclick="Action.setThumb()" class="setThumb" title="'+$lang.selectThumb+'"></a>			<a href="#" onclick="Action.setFile()" class="setFile" title="'+$lang.select+'"></a>	'),$cfg.contextmenu&&($cfg.menu.file=[{'<span lang="select">Select</span>':{onclick:function(){return Action.setFile()},icon:"skin/_ico/arrow_rotate_anticlockwise.png"}},{'<span lang="selectThumb">Select this thumbnail</span>':{onclick:function(){return Action.setThumb()},disabled:!1,icon:"skin/_ico/arrow_out.png"}},$.contextMenu.separator,{'<span lang="lookAt">Look</span>':{onclick:function(){return Action.lookFile()},icon:"skin/_ico/eye.png"}},{'<span lang="downloadFile">Download file</span>':{onclick:function(){return Action.downloadFile()},icon:"skin/_ico/arrow_down.png"}},{'<span lang="renameFile">Rename file</span>':{onclick:function(){return Action.renameFile()},icon:"skin/_ico/application_xp_terminal.png"}},$.contextMenu.separator,{'<span lang="deleteFile">Delete file</span>':{onclick:function(){return Action.deleteFile()},icon:"skin/_ico/cross.png"}},{'<span lang="deleteCheckedFile">Delete checked files</span>':{onclick:function(){return Action.deleteFiles()},icon:"skin/_ico/delete.png"}}],$cfg.menu.folder=[{'<span lang="createFolder">Create folder</span>':{onclick:function(){return Action.createFolder()},icon:"skin/_ico/folder_add.png"}},{'<span lang="renameFolder">Rename folder</span>':{onclick:function(){return Action.renameFolder()},icon:"skin/_ico/application_xp_terminal.png"}},{'<span lang="deleteFolder">Delete folder</span>':{onclick:function(){return Action.deleteFolder()},icon:"skin/_ico/folder_delete.png"}},$.contextMenu.separator,{'<span lang="uploadSelectFiles">Upload selected files</span>':{onclick:function(){return Action.uploadFolder()},icon:"skin/_ico/arrow_up.png"}}]),$(dialogDiv).dialog({bgiframe:!0,resizable:!1,width:400,height:180,modal:!0,autoOpen:!1,overlay:{backgroundColor:"#000",opacity:.5},buttons:{Cancel:function(){$(this).dialog("close")}," OK ":function(){var e=$("#newName").val();return/^[a-z0-9-_#~\$%()\[\]&=]+/i.test(e)?($(this).dialog("close"),$("#dialog input").attr("disabled","disabled"),$.post($ajaxConnector+"?mode="+$cfg.tmp.mode,{dir:$cfg.dir,type:$cfg.type,lang:$cfg.lang,oldname:$cfg.tmp.oldname,newname:e},function(e){if(!e.isSuccess||"createFolder"!=$cfg.tmp.mode&&"renameFolder"!=$cfg.tmp.mode)appendFiles(e);else{if("exist"==e.isSuccess)return $(">div.l",statusDiv).html('<div class="warning"><b>'+$lang.folderExist+"</b></div>"),void 0;var t=$("#dirsList").dynatree("getTree"),i=t.getNodeByKey(encodeURIComponent($cfg.tmp.key));i.reload(!0)}},"json"),void 0):!1}}}),$("#author a").length?$("#author a").attr("target","_blank"):$("#files").html("")});var cssFix=function(){var e=navigator.userAgent.toLowerCase(),t=function(t){return-1!=e.indexOf(t)};$("html").addClass([!/opera|webtv/i.test(e)&&/msie (\d)/.test(e)?"ie ie"+RegExp.$1:t("firefox/2")?"gecko ff2":t("firefox/3")?"gecko ff3":t("gecko/")?"gecko":t("chrome/")?"chrome":t("opera/9")?"opera opera9":/opera (\d)/.test(e)?"opera opera"+RegExp.$1:t("konqueror")?"konqueror":t("applewebkit/")?"webkit safari":t("mozilla/")?"gecko":"",t("x11")||t("linux")?" linux":t("mac")?" mac":t("win")?" win":""].join(""))}();