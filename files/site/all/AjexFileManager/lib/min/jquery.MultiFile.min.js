$.fn.MultiFile=function(e){if(0==this.length)return this;if("string"==typeof arguments[0]){if(this.length>1){var t=arguments;return this.each(function(){$.fn.MultiFile.apply($(this),t)})}return $.fn.MultiFile[arguments[0]].apply(this,$.makeArray(arguments).slice(1)||[]),this}var e=$.extend({},$.fn.MultiFile.options,e||{});$("form").not("MultiFile-intercepted").addClass("MultiFile-intercepted").submit($.fn.MultiFile.disableEmpty),$.fn.MultiFile.options.autoIntercept&&($.fn.MultiFile.intercept($.fn.MultiFile.options.autoIntercept),$.fn.MultiFile.options.autoIntercept=null),this.not(".MultiFile-applied").addClass("MultiFile-applied").each(function(){window.MultiFile=(window.MultiFile||0)+1;var t=window.MultiFile,i={e:this,E:$(this),clone:$(this).clone()};"number"==typeof e&&(e={max:e});var a=$.extend({},$.fn.MultiFile.options,e||{},($.metadata?i.E.metadata():$.meta?i.E.data():null)||{},{});a.max>0||(a.max=i.E.attr("maxlength"),a.max>0||(a.max=(String(i.e.className.match(/\b(max|limit)\-([0-9]+)\b/gi)||[""]).match(/[0-9]+/gi)||[""])[0],a.max=a.max>0?String(a.max).match(/[0-9]+/gi)[0]:-1)),a.max=new Number(a.max),a.accept=a.accept||i.E.attr("accept")||"",a.accept||(a.accept=i.e.className.match(/\b(accept\-[\w\|]+)\b/gi)||"",a.accept=new String(a.accept).replace(/^(accept|ext)\-/i,"")),$.extend(i,a||{}),i.STRING=$.extend({},$.fn.MultiFile.options.STRING,i.STRING),$.extend(i,{n:0,slaves:[],files:[],instanceKey:i.e.id||"MultiFile"+String(t),generateID:function(e){return i.instanceKey+(e>0?"_F"+String(e):"")},trigger:function(e,t){var a=i[e],n=$(t).attr("value");if(a){var l=a(t,n,i);if(null!=l)return l}return!0}}),String(i.accept).length>1&&(i.accept=i.accept.replace(/\W+/g,"|").replace(/^\W|\W$/g,""),i.rxAccept=new RegExp("\\.("+(i.accept?i.accept:"")+")$","gi")),i.wrapID=i.instanceKey+"_wrap",i.E.wrap('<div class="MultiFile-wrap" id="'+i.wrapID+'"></div>'),i.wrapper=$("#"+i.wrapID),i.e.name=i.e.name||"file"+t+"[]",i.list||(i.wrapper.append('<div class="MultiFile-list" id="'+i.wrapID+'_list"></div>'),i.list=$("#"+i.wrapID+"_list")),i.list=$(i.list),i.addSlave=function(e,a){i.n++,e.MultiFile=i,a>0&&(e.id=e.name=""),a>0&&(e.id=i.generateID(a)),e.name=String(i.namePattern.replace(/\$name/gi,$(i.clone).attr("name")).replace(/\$id/gi,$(i.clone).attr("id")).replace(/\$g/gi,t).replace(/\$i/gi,a)),i.max>0&&i.n-1>i.max&&(e.disabled=!0),i.current=i.slaves[a]=e,e=$(e),e.val("").attr("value","")[0].value="",e.addClass("MultiFile-applied"),e.change(function(){if($(this).blur(),!i.trigger("onFileSelect",this,i))return!1;var t="",n=String(this.value||"");i.accept&&n&&!n.match(i.rxAccept)&&(t=i.STRING.denied.replace("$ext",String(n.match(/\.\w{1,4}$/gi))));for(var l in i.slaves)i.slaves[l]&&i.slaves[l]!=this&&i.slaves[l].value==n&&(t=i.STRING.duplicate.replace("$file",n.match(/[^\/\\]+$/gi)));var r=$(i.clone).clone();return r.addClass("MultiFile"),""!=t?(i.error(t),i.n--,i.addSlave(r[0],a),e.parent().prepend(r),e.remove(),!1):($(this).css({position:"absolute",top:"-3000px"}),e.after(r),i.addToList(this,a),i.addSlave(r[0],a+1),i.trigger("afterFileSelect",this,i)?void 0:!1)}),$(e).data("MultiFile",i)},i.addToList=function(e,t){if(!i.trigger("onFileAppend",e,i))return!1;var a=$('<div class="MultiFile-label"></div>'),n=String(e.value||""),l=$('<span class="MultiFile-title" title="'+i.STRING.selected.replace("$file",n)+'">'+i.STRING.file.replace("$file",n.match(/[^\/\\]+$/gi)[0])+"</span>"),r=$('<a class="MultiFile-remove" href="#'+i.wrapID+'">'+i.STRING.remove+"</a>");return i.list.append(a.append(r," ",l)),r.click(function(){return i.trigger("onFileRemove",e,i)?(i.n--,i.current.disabled=!1,i.slaves[t]=null,$(e).remove(),$(this).parent().remove(),$(i.current).css({position:"",top:""}),$(i.current).reset().val("").attr("value","")[0].value="",i.trigger("afterFileRemove",e,i)?!1:!1):!1}),i.trigger("afterFileAppend",e,i)?void 0:!1},i.MultiFile||i.addSlave(i.e,0),i.n++,i.E.data("MultiFile",i)})},$.extend($.fn.MultiFile,{reset:function(){var e=$(this).data("MultiFile");return e&&e.list.find("a.MultiFile-remove").click(),$(this)},disableEmpty:function(e){e=("string"==typeof e?e:"")||"mfD";var t=[];return $("input:file.MultiFile").each(function(){""==$(this).val()&&(t[t.length]=this)}),$(t).each(function(){this.disabled=!0}).addClass(e)},reEnableEmpty:function(e){return e=("string"==typeof e?e:"")||"mfD",$("input:file."+e).removeClass(e).each(function(){this.disabled=!1})},intercepted:{},intercept:function(e,t,i){var a,n;if(i=i||[],i.constructor.toString().indexOf("Array")<0&&(i=[i]),"function"==typeof e)return $.fn.MultiFile.disableEmpty(),n=e.apply(t||window,i),setTimeout(function(){$.fn.MultiFile.reEnableEmpty()},1e3),n;e.constructor.toString().indexOf("Array")<0&&(e=[e]);for(var l=0;l<e.length;l++)a=e[l]+"",a&&function(e){$.fn.MultiFile.intercepted[e]=$.fn[e]||function(){},$.fn[e]=function(){return $.fn.MultiFile.disableEmpty(),n=$.fn.MultiFile.intercepted[e].apply(this,arguments),setTimeout(function(){$.fn.MultiFile.reEnableEmpty()},1e3),n}}(a)}}),$.fn.MultiFile.options={accept:"",max:-1,namePattern:"$name",STRING:{remove:"x",denied:"You cannot select a $ext file.\nTry again...",file:"$file",selected:"File selected: $file",duplicate:"This file has already been selected:\n$file"},autoIntercept:["submit","ajaxSubmit","ajaxForm","validate"],error:function(e){alert(e)}},$.fn.reset=function(){return this.each(function(){try{this.reset()}catch(e){}})},$(function(){});